<!DOCTYPE html>
<html lang="en">
    <head>
        <meta http-equiv="X-UA-Compatible" content="IE=8">
        <meta charset="UTF-8">
        <title>Ol3</title>
    </head>
    <link rel="stylesheet" href="http://openlayers.org/en/v3.0.0/css/ol.css" type="text/css">
    <style type="text/css">
        html, body {
            height: 100%;
            margin: 0;
        }

        .map_fullscreen {
            width: 100%;
            height: 100%;
        }
    </style>
    <body>
        <div id="map" class="map_fullscreen"></div>
        <script src="http://openlayers.org/en/v3.0.0/build/ol.js" type="text/javascript"></script>
        <script src="http://code.jquery.com/jquery-2.1.1.min.js"></script>
        <script type="text/javascript">

            var Mab = this.Mab || {};
            (function (ns) {

                //this could (should?) be moved to a separate file
                var ol3utils = window.ol3utils || {};
                ol3utils.SkTiles = function (options) {
                    /**
                        Tiles from Statkart. Available layers are:
                            - matrikkel_bakgrunn
                            - topo2
                            - topo2graatone 
                            - europa
                            - toporaster2
                            - sjo_hovedkart2
                            - kartdata2 
                            - norges_grunnkart 
                            - norges_grunnkart_graatone

                        See http://statkart.no/Kart/Kartverksted/Visningstjenester/
                    **/
                    return new ol.layer.Tile({
                        source: new ol.source.XYZ({
                            attributions: [
                                new ol.Attribution({
                                    html: "&copy; <a href='http://statkart.no'>Kartverket</a>"
                                })
                            ],
                            url: 'http://opencache.statkart.no/gatekeeper/gk/gk.open_gmaps?layers=' + options.layers + '&zoom={z}&x={x}&y={y}'
                        })
                    })
                };

                var wfsSource = new ol.source.ServerVector({
                    format: new ol.format.GeoJSON(),
                    loader: function(extent, resolution, projection) {
                        var url = 'http://geo.barentswatch.no/geoserver/bw/ows?service=WFS&version=1.1.0&' +
                            'request=GetFeature&typeName=bw:waveforecast_area_iso_current&' +
                            'outputFormat=text/javascript&format_options=callback:loadFeatures&' +
                            'srsname=EPSG:3857&bbox=' + extent.join(',') + ',EPSG:3857';
                        $.ajax({
                            url: url,
                            dataType: 'jsonp'
                        });

                    },
                    strategy: ol.loadingstrategy.createTile(new ol.tilegrid.XYZ({
                        maxZoom: 19
                    })),
                    projection: 'EPSG:3857'
                });

                loadFeatures = function(response) {
                    wfsSource.addFeatures(wfsSource.readFeatures(response));
                };

                var wfsLayer = new ol.layer.Vector({
                    source: wfsSource,
                    style: new ol.style.Style({
                        stroke: new ol.style.Stroke({
                            color: 'rgba(0,0,255,1.0)',
                            width: 2
                        })
                    })
                });

                //actually set up the map
                var map = new ol.Map({
                    target: 'map',
                    layers: [
                        new ol3utils.SkTiles({layers: "norges_grunnkart"}),
                        /*new ol.layer.Image({
                            source: new ol.source.ImageWMS({
                                url: 'http://geo.barentswatch.no/geoserver/bw/wms?',
                                params: {'LAYERS' : 'bw:waveforecast_area_iso_current'},
                            })
                        }),*/
                        wfsLayer
                    ],
                    view: new ol.View({
                        center: ol.proj.transform([15, 64.5], 'EPSG:4326', 'EPSG:3857'),
                        zoom: 5
                    })
                });
            }(Mab));
        </script>
    </body>
</html>